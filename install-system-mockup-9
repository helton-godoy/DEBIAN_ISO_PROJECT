#!/bin/bash
# install-system-mockup-9
# "Aurora" - Instalador TUI Premium para Debian ZFS NAS
# MODO MOCKUP: Todas as funÃ§Ãµes reais DESATIVADAS para desenvolvimento estÃ©tico
# Desenvolvido com Antigravity Intelligence - 2026-01-29
# Claude Opus 4.5 (Thinking)

# set -e DESATIVADO para permitir testes sem interrupÃ§Ã£o
# set -e

# --- Paleta de Cores Aurora ---
COLOR_PRIMARY=212   # Rosa/Roxo (cor principal Aurora)
COLOR_SECONDARY=123 # Azul ciano (secundÃ¡ria)
COLOR_SUCCESS=40    # Verde
COLOR_ERROR=196     # Vermelho
COLOR_WARNING=214   # Amarelo/Laranja
COLOR_ACCENT=135    # Roxo mais claro
COLOR_MUTED=245     # Cinza suave

# --- ConfiguraÃ§Ãµes do Pool (apenas para exibiÃ§Ã£o) ---
POOL_NAME="zroot"

# --- FunÃ§Ãµes de UI Aurora Premium ---

aurora_banner() {
	clear
	# ASCII Art com gradiente de cores
	gum style --foreground $COLOR_PRIMARY "
    â–‘â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—â–‘â–ˆâ–ˆâ•—â–‘â–‘â–‘â–ˆâ–ˆâ•—â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—â–‘â–‘â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—â–‘â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—â–‘â–‘â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—â–‘
    â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•—â–ˆâ–ˆâ•‘â–‘â–‘â–‘â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•—â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•—â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•—â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•—
    â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘â–‘â–‘â–‘â–ˆâ–ˆâ•‘â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•”â•â–ˆâ–ˆâ•‘â–‘â–‘â–ˆâ–ˆâ•‘â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•”â•â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•‘
    â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘â–‘â–‘â–‘â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•—â–ˆâ–ˆâ•‘â–‘â–‘â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•—â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•‘
    â–ˆâ–ˆâ•‘â–‘â–‘â–ˆâ–ˆâ•‘â•šâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•”â•â–ˆâ–ˆâ•‘â–‘â–‘â–ˆâ–ˆâ•‘â•šâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•”â•â–ˆâ–ˆâ•‘â–‘â–‘â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘â–‘â–‘â–ˆâ–ˆâ•‘
    â•šâ•â•â–‘â–‘â•šâ•â•â–‘â•šâ•â•â•â•â•â•â–‘â•šâ•â•â–‘â–‘â•šâ•â•â–‘â•šâ•â•â•â•â•â–‘â•šâ•â•â–‘â–‘â•šâ•â•â•šâ•â•â–‘â–‘â•šâ•â•"

	gum style \
		--foreground $COLOR_SECONDARY --border-foreground $COLOR_PRIMARY --border rounded \
		--align center --width 60 --margin "0 2" --padding "0 2" \
		"âš¡ Debian ZFS NAS âš¡" \
		"High Performance Storage Solution"
}

logo() {
	clear
	gum style \
		--foreground $COLOR_PRIMARY --border-foreground $COLOR_PRIMARY --border double \
		--align center --width 60 --margin "1 2" --padding "0 1" \
		"âœ¨ AURORA INSTALLER âœ¨" "Debian ZFS NAS - High Performance Storage"
}

header() {
	echo ""
	gum style --foreground $COLOR_SECONDARY --bold "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
	gum style --foreground $COLOR_PRIMARY --bold "  â–¶ $1"
	gum style --foreground $COLOR_SECONDARY --bold "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
}

subheader() {
	gum style --foreground $COLOR_ACCENT --italic "    â†³ $1"
}

success_msg() {
	gum style --foreground $COLOR_SUCCESS "  âœ“ $1"
}

error_box() {
	gum style --foreground $COLOR_ERROR --border-foreground $COLOR_ERROR --border normal \
		--padding "0 1" --margin "1 1" "âŒ ERRO: $1"
}

warning_box() {
	gum style --foreground $COLOR_WARNING --border-foreground $COLOR_WARNING --border normal \
		--padding "0 1" --margin "1 1" "âš ï¸  AVISO: $1"
}

info_box() {
	gum style --foreground $COLOR_SECONDARY --border-foreground $COLOR_ACCENT --border rounded \
		--padding "0 1" --margin "1 1" "â„¹ï¸  $1"
}

divider() {
	gum style --foreground $COLOR_MUTED "  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
}

# Barra de progresso global
PROGRESS_CURRENT=0
PROGRESS_TOTAL=8

progress_bar() {
	local step_name="$1"
	((PROGRESS_CURRENT++))
	local pct=$((PROGRESS_CURRENT * 100 / PROGRESS_TOTAL))
	local filled=$((pct / 5))
	local empty=$((20 - filled))
	local bar=$(printf 'â–ˆ%.0s' $(seq 1 $filled))$(printf 'â–‘%.0s' $(seq 1 $empty))

	gum style --foreground $COLOR_ACCENT "  [$bar] $pct% - Etapa $PROGRESS_CURRENT/$PROGRESS_TOTAL"
	gum style --foreground $COLOR_MUTED --italic "    $step_name"
}

# Spinner com simulaÃ§Ã£o (MOCKUP)
run_step_mock() {
	local title="$1"
	local sleep_time="${2:-2}"
	gum spin --spinner dot --title "$title" -- sleep "$sleep_time"
	success_msg "ConcluÃ­do: $title"
}

# --- DADOS MOCKUP ---
mock_disk_list() {
	cat <<'EOF'
sda (500GB) - Samsung SSD 870 EVO
sdb (2TB) - Seagate IronWolf NAS
nvme0n1 (1TB) - WD Black SN850X
vda (64GB) - Virtual Disk
EOF
}

# --- InÃ­cio do Script ---

aurora_banner
sleep 1

# 1. VerificaÃ§Ãµes de Hardware (MOCKUP)
header "ğŸ” Verificando ambiente..."
run_step_mock "Detectando hardware..." 1
success_msg "Ambiente UEFI detectado."
success_msg "Controladora SATA/NVMe detectada."
success_msg "MÃ³dulos ZFS carregados."

# 2. SeleÃ§Ã£o de Disco (MOCKUP)
logo
header "ğŸ’¾ Selecione o disco de destino"
warning_box "Todos os dados no disco selecionado serÃ£o APAGADOS!"

echo ""
gum style --foreground $COLOR_MUTED "  Discos disponÃ­veis detectados:"
divider

TARGET_SELECTED=$(mock_disk_list | gum choose --height 8 --cursor.foreground $COLOR_PRIMARY)
TARGET_DISK="/dev/$(echo "$TARGET_SELECTED" | awk '{print $1}')"

success_msg "Disco selecionado: $TARGET_DISK"

# 3. InformaÃ§Ãµes do UsuÃ¡rio
logo
header "ğŸ‘¤ ConfiguraÃ§Ã£o de Conta"

subheader "Defina o nome de usuÃ¡rio administrador"
ADM_USER=$(gum input --placeholder "Nome do usuÃ¡rio (ex: admin)" --value "helton" \
	--prompt.foreground $COLOR_PRIMARY --cursor.foreground $COLOR_ACCENT)

echo ""
subheader "Defina a senha para $ADM_USER e Root"
while true; do
	ADM_PASS=$(gum input --password --placeholder "Digite a senha" \
		--prompt.foreground $COLOR_PRIMARY --cursor.foreground $COLOR_ACCENT)
	CONFIRM_PASS=$(gum input --password --placeholder "Confirme a senha" \
		--prompt.foreground $COLOR_PRIMARY --cursor.foreground $COLOR_ACCENT)

	if [ "$ADM_PASS" = "$CONFIRM_PASS" ] && [ -n "$ADM_PASS" ]; then
		success_msg "Senha definida com sucesso!"
		break
	fi
	gum style --foreground $COLOR_ERROR "  âœ— As senhas nÃ£o conferem ou estÃ£o vazias. Tente novamente."
done

# 4. Hostname
logo
header "ğŸ–¥ï¸  ConfiguraÃ§Ã£o de Rede"

subheader "Defina o hostname do sistema"
HOSTNAME=$(gum input --placeholder "Hostname (ex: nas-zfs)" --value "aurora-nas" \
	--prompt.foreground $COLOR_PRIMARY --cursor.foreground $COLOR_ACCENT)

# 5. ConfirmaÃ§Ã£o Final com Tabela Premium
logo
header "ğŸ“‹ Resumo da InstalaÃ§Ã£o"

echo ""
gum style --border-foreground $COLOR_ACCENT --border rounded --padding "1 2" --margin "1 2" \
	"$(gum join --vertical \
		"$(gum style --width 50 "$(gum style --foreground $COLOR_MUTED '  Disco:')        $(gum style --foreground $COLOR_PRIMARY --bold "$TARGET_DISK")")" \
		"$(gum style --width 50 "$(gum style --foreground $COLOR_MUTED '  Tamanho:')      $(gum style --foreground $COLOR_PRIMARY --bold "$(echo $TARGET_SELECTED | awk -F'[()]' '{print $2}')")")" \
		"$(gum style --width 50 "$(gum style --foreground $COLOR_MUTED '  UsuÃ¡rio:')      $(gum style --foreground $COLOR_PRIMARY --bold "$ADM_USER")")" \
		"$(gum style --width 50 "$(gum style --foreground $COLOR_MUTED '  Hostname:')     $(gum style --foreground $COLOR_PRIMARY --bold "$HOSTNAME")")" \
		"$(gum style --width 50 "$(gum style --foreground $COLOR_MUTED '  Filesystem:')   $(gum style --foreground $COLOR_PRIMARY --bold "ZFS on Root (ZBM)")")" \
		"$(gum style --width 50 "$(gum style --foreground $COLOR_MUTED '  Pool:')         $(gum style --foreground $COLOR_PRIMARY --bold "$POOL_NAME")")")"

echo ""
gum confirm "ğŸš€ Confirmar inÃ­cio da instalaÃ§Ã£o? O disco serÃ¡ formatado." --default=false \
	--affirmative "âœ“ PROSSEGUIR" --negative "âœ— CANCELAR" \
	--prompt.foreground "$COLOR_PRIMARY" --selected.background "$COLOR_PRIMARY" || exit 1

# 6. ExecuÃ§Ã£o TÃ©cnica com Spinners (MOCKUP)
logo
header "âš™ï¸  Executando InstalaÃ§Ã£o..."

echo ""
info_box "MODO MOCKUP: Nenhuma operaÃ§Ã£o real serÃ¡ executada"
echo ""

progress_bar "Preparando disco"
run_step_mock "Limpando disco $TARGET_DISK..." 1
run_step_mock "Verificando integridade do dispositivo..." 0.5

progress_bar "Particionamento"
run_step_mock "Configurando partiÃ§Ã£o EFI (512MB)..." 1
run_step_mock "Criando partiÃ§Ã£o ZFS (restante)..." 1

progress_bar "Pool ZFS"
run_step_mock "Criando Pool ZFS ($POOL_NAME)..." 2
subheader "OpÃ§Ãµes: ashift=12, compression=lz4, acltype=posixacl"

progress_bar "Datasets ZFS"
run_step_mock "Criando dataset ROOT/debian..." 1
run_step_mock "Criando dataset /home..." 0.5
run_step_mock "Criando dataset /root..." 0.5
run_step_mock "Configurando propriedades bootfs..." 0.5

progress_bar "Montagem do sistema"
run_step_mock "Montando hierarquia ZFS em /mnt..." 1
run_step_mock "Montando partiÃ§Ã£o EFI em /mnt/boot/efi..." 0.5

progress_bar "Sistema base"
run_step_mock "Extraindo arquivos do SquashFS (simulando 4.2GB)..." 5
subheader "Total: 65.432 arquivos extraÃ­dos"

progress_bar "ConfiguraÃ§Ã£o do sistema"
run_step_mock "Configurando hostname ($HOSTNAME)..." 0.5
run_step_mock "Configurando rede (DHCP)..." 0.5
run_step_mock "Gerando machine-id Ãºnico..." 0.5
run_step_mock "Criando usuÃ¡rio $ADM_USER..." 0.5

progress_bar "Bootloader"
run_step_mock "Instalando ZFSBootMenu..." 2
run_step_mock "Configurando entrada UEFI..." 1
run_step_mock "Atualizando initramfs..." 2

# 7. Tela de ConclusÃ£o Premium
clear
gum style --foreground $COLOR_SUCCESS "
    â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—â–‘â–‘â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—â–‘â–ˆâ–ˆâ–ˆâ•—â–‘â–‘â–ˆâ–ˆâ•—â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—â–ˆâ–ˆâ•—
    â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•—â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•—â–ˆâ–ˆâ–ˆâ–ˆâ•—â–‘â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•”â•â•â•â•â•â–ˆâ–ˆâ•‘
    â–ˆâ–ˆâ•‘â–‘â–‘â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘â–‘â–‘â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•”â–ˆâ–ˆâ•—â–ˆâ–ˆâ•‘â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—â–‘â–‘â–ˆâ–ˆâ•‘
    â–ˆâ–ˆâ•‘â–‘â–‘â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘â–‘â–‘â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘â•šâ–ˆâ–ˆâ–ˆâ–ˆâ•‘â–ˆâ–ˆâ•”â•â•â•â–‘â–‘â•šâ•â•
    â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•”â•â•šâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•”â•â–ˆâ–ˆâ•‘â–‘â•šâ–ˆâ–ˆâ–ˆâ•‘â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—â–ˆâ–ˆâ•—
    â•šâ•â•â•â•â•â•â–‘â–‘â•šâ•â•â•â•â•â–‘â•šâ•â•â–‘â–‘â•šâ•â•â•â•šâ•â•â•â•â•â•â•â•šâ•â•"

echo ""
gum style --foreground $COLOR_SUCCESS --border-foreground $COLOR_SUCCESS --border double \
	--padding "1 3" --margin "1 2" --align center \
	"âœ¨ INSTALAÃ‡ÃƒO CONCLUÃDA COM SUCESSO! âœ¨" \
	"" \
	"UsuÃ¡rio: $ADM_USER" \
	"Hostname: $HOSTNAME" \
	"Filesystem: ZFS on Root" \
	"" \
	"ğŸ’¡ Dica: Remova a mÃ­dia Live e reinicie o sistema."

echo ""
gum style --foreground $COLOR_MUTED --italic "  [MOCKUP] Sistema nÃ£o modificado - apenas demonstraÃ§Ã£o visual"
echo ""

if gum confirm "ğŸ”„ Deseja reiniciar agora?" \
	--affirmative "Sim, reiniciar" --negative "NÃ£o, voltar ao terminal" \
	--prompt.foreground "$COLOR_PRIMARY" --selected.background "$COLOR_PRIMARY"; then
	gum style --foreground $COLOR_PRIMARY "  Reiniciando... (simulado)"
	sleep 2
	gum style --foreground $COLOR_SUCCESS "  [MOCKUP] ReinÃ­cio simulado concluÃ­do!"
fi

echo ""
gum style --foreground $COLOR_ACCENT "  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
gum style --foreground $COLOR_PRIMARY --bold "  Obrigado por usar o Aurora Installer!"
gum style --foreground $COLOR_ACCENT "  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
echo ""
