#!/bin/bash
# install-system-mockup-11
# "Aurora" - Instalador TUI Premium para Debian ZFS NAS
# Desenvolvido com Antigravity Intelligence - 2026-01-28

set -e

# --- ConfiguraÃ§Ãµes do Pool ---
POOL_NAME="zroot"
ZFS_OPTS="-o ashift=12 -O compression=lz4 -O acltype=posixacl -O xattr=sa -O dnodesize=auto -O normalization=formD -O mountpoint=none -O canmount=off -O devices=off"

# --- FunÃ§Ãµes de UI Aurora Aprimorada ---

# Paleta de cores Aurora
AURORA_PRIMARY=212
AURORA_SUCCESS=40
AURORA_INFO=220
AURORA_WARNING=208
AURORA_ERROR=196
AURORA_ACCENT=123

# FunÃ§Ã£o para criar separadores visuais
separator() {
    gum style --foreground $AURORA_ACCENT --bold "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
}

# FunÃ§Ã£o para criar Ã­cones
icon() {
    case $1 in
        "logo") echo "ğŸŒ…" ;;
        "disk") echo "ğŸ’¾" ;;
        "settings") echo "âš™ï¸" ;;
        "user") echo "ğŸ‘¤" ;;
        "check") echo "âœ…" ;;
        "info") echo "â„¹ï¸" ;;
        "warning") echo "âš ï¸" ;;
        "error") echo "âŒ" ;;
        "progress") echo "ğŸ”„" ;;
        "boot") echo "ğŸš€" ;;
        *) echo "â€¢" ;;
    esac
}

# Barra de progresso geral
progress_bar() {
    local current=$1
    local total=$2
    local width=30
    local filled=$((current * width / total))
    local empty=$((width - filled))
    
    local bar=""
    for ((i=0; i<filled; i++)); do bar+="â–ˆ"; done
    for ((i=0; i<empty; i++)); do bar+="â–‘"; done
    
    gum style --foreground $AURORA_PRIMARY "[$bar] $current/$total"
}

logo() {
    clear
    # Logo Aurora melhorado com gradiente visual
    separator
    gum style \
        --foreground $AURORA_PRIMARY --border-foreground $AURORA_PRIMARY --border double \
        --align center --width 70 --margin "1 2" --padding "1 2" \
        "$(icon logo) AURORA INSTALLER $(icon logo)" \
        "Debian ZFS NAS - High Performance Storage" \
        "" \
        "$(icon progress) Instalador Premium com Interface AvanÃ§ada"
    separator
}

header() {
    echo ""
    gum style --foreground $AURORA_ACCENT --bold "$(icon settings) â”€â”€ $1"
    separator
}

error_box() {
    echo ""
    separator
    gum style --foreground $AURORA_ERROR --border-foreground $AURORA_ERROR --border thick \
        --padding "1 2" --margin "0 1" --align center "$(icon error) ERRO: $1"
    separator
}

# --- InÃ­cio do Script ---

logo

# 1. VerificaÃ§Ãµes de Hardware
header "Verificando ambiente..."
gum style --foreground $AURORA_INFO "$(icon info) Analisando configuraÃ§Ã£o do sistema..."
if [ ! -d /sys/firmware/efi ]; then
    error_box "O sistema nÃ£o iniciou via UEFI. O Aurora requer UEFI."
    exit 1
fi
gum style --foreground $AURORA_SUCCESS "$(icon check) Ambiente UEFI detectado com sucesso."

# 2. SeleÃ§Ã£o de Disco style Proxmox Melhorado
header "SeleÃ§Ã£o de Disco de Destino"
echo ""
gum style --foreground $AURORA_WARNING --align center "$(icon warning) ATENÃ‡ÃƒO: Todos os dados no disco selecionado serÃ£o APAGADOS."
echo ""
separator

DISK_LIST=$(lsblk -dno NAME,SIZE,MODEL | grep -v "loop" | awk '{print $1" ("$2") - "$3}')

if [ -z "$DISK_LIST" ]; then
    error_box "Nenhum disco encontrado disponÃ­vel para instalaÃ§Ã£o."
    exit 1
fi

gum style --foreground $AURORA_INFO "$(icon disk) Discos disponÃ­veis:"
TARGET_SELECTED=$(echo "$DISK_LIST" | gum choose --height 10 --cursor.foreground="$AURORA_PRIMARY")
TARGET_DISK="/dev/$(echo "$TARGET_SELECTED" | awk '{print $1}')

gum style --foreground $AURORA_SUCCESS "$(icon check) Disco selecionado: $TARGET_DISK"

# 3. InformaÃ§Ãµes do UsuÃ¡rio com EstÃ©tica Aprimorada
logo
header "ConfiguraÃ§Ã£o de Conta de UsuÃ¡rio"
separator

gum style --foreground $AURORA_INFO "$(icon user) Configurando credenciais de acesso..."
echo ""

ADM_USER=$(gum input --placeholder "Nome do usuÃ¡rio (ex: admin)" --value "helton")

header "DefiniÃ§Ã£o de Senha Segura"
echo ""
gum style --foreground $AURORA_INFO "$(icon info) A senha serÃ¡ usada para o usuÃ¡rio e root."
echo ""

while true; do
    ADM_PASS=$(gum input --password --placeholder "Digite uma senha forte")
    CONFIRM_PASS=$(gum input --password --placeholder "Confirme a senha")
    
    if [ "$ADM_PASS" = "$CONFIRM_PASS" ] && [ -n "$ADM_PASS" ]; then
        gum style --foreground $AURORA_SUCCESS "$(icon check) Senha configurada com sucesso!"
        break
    fi
    gum style --foreground $AURORA_ERROR "$(icon error) As senhas nÃ£o conferem ou estÃ£o vazias. Tente novamente."
done
separator

# 4. ConfirmaÃ§Ã£o Final com Cards Melhorados
logo
header "Resumo da InstalaÃ§Ã£o"
separator
gum style --foreground $AURORA_INFO "$(icon info) Revise as configuraÃ§Ãµes antes de prosseguir:"
echo ""

# Cards de informaÃ§Ã£o
gum join --vertical \
    "$(gum style --foreground $AURORA_ACCENT --bold "$(icon disk) Disco de Destino:") $(gum style --foreground $AURORA_PRIMARY "$TARGET_DISK")" \
    "$(gum style --foreground $AURORA_ACCENT --bold "$(icon user) UsuÃ¡rio Admin:") $(gum style --foreground $AURORA_PRIMARY "$ADM_USER")" \
    "$(gum style --foreground $AURORA_ACCENT --bold "$(icon settings) Hostname:") $(gum style --foreground $AURORA_PRIMARY "nas-zfs")" \
    "$(gum style --foreground $AURORA_ACCENT --bold "$(icon boot) Sistema de Arquivos:") $(gum style --foreground $AURORA_PRIMARY "ZFS on Root (ZBM)")"

echo ""
separator
gum style --foreground $AURORA_WARNING --align center "$(icon warning) ESTA OPERAÃ‡ÃƒO IRÃ APAGAR TODOS OS DADOS DO DISCO!"
echo ""
gum confirm "Confirmar inÃ­cio da instalaÃ§Ã£o?" --default=false \
    --affirmative "ğŸš€ PROSSEGUIR" --negative "âŒ CANCELAR" || exit 1

# 5. ExecuÃ§Ã£o TÃ©cnica com Spinners e Progresso
logo
header "Iniciando Processo de InstalaÃ§Ã£o"
separator

# VariÃ¡vel de controle de progresso
STEP_CURRENT=0
STEP_TOTAL=8

# FunÃ§Ã£o para exibir progresso geral
show_progress() {
    echo ""
    gum style --foreground $AURORA_ACCENT --bold "Progresso Geral:"
    progress_bar $STEP_CURRENT $STEP_TOTAL
    echo ""
}

# FunÃ§Ã£o para simular comandos com spinner e timer
run_step() {
    local title="$1"
    local duration=${2:-3}
    
    ((STEP_CURRENT++))
    show_progress
    
    gum style --foreground $AURORA_INFO "$(icon progress) $title"
    gum spin --spinner minidot --title "Processando..." -- sleep $duration
    gum style --foreground $AURORA_SUCCESS "$(icon check) $title - ConcluÃ­do"
    separator
}

run_step 'Limpando disco $TARGET_DISK...' 2

run_step 'Configurando partiÃ§Ã£o EFI (512MB)...' 3

run_step 'Criando Pool ZFS ($POOL_NAME)...' 4

run_step 'Configurando Datasets ZFS...' 3

run_step 'Montando sistema de arquivos...' 2

# InstalaÃ§Ã£o Base (SimulaÃ§Ã£o)
header "Instalando Sistema Base"
gum style --foreground $AURORA_INFO "$(icon info) Simulando extraÃ§Ã£o do sistema base..."
run_step 'Extraindo arquivos para o ZFS...' 5

# ConfiguraÃ§Ãµes (SimulaÃ§Ã£o)
header "Configurando InstÃ¢ncia"
gum style --foreground $AURORA_INFO "$(icon settings) Configurando hostname, rede e fstab..."
sleep 2
gum style --foreground $AURORA_SUCCESS "$(icon check) ConfiguraÃ§Ãµes do sistema aplicadas"
separator

# ZFSBootMenu (SimulaÃ§Ã£o)
header "Configurando Bootloader"
gum style --foreground $AURORA_INFO "$(icon boot) Baixando e configurando ZFSBootMenu..."
run_step 'Instalando bootloader EFI...' 3
gum style --foreground $AURORA_SUCCESS "$(icon check) Bootloader configurado com sucesso"
separator

# Chroot Finalization (SimulaÃ§Ã£o)
header "Finalizando ConfiguraÃ§Ãµes"
gum style --foreground $AURORA_INFO "$(icon user) Configurando usuÃ¡rio e sistema final..."
run_step 'Aplicando configuraÃ§Ãµes finais...' 4
gum style --foreground $AURORA_SUCCESS "$(icon check) Sistema finalizado com sucesso"
separator

# Tela de Sucesso Aprimorada
logo
separator
gum style --foreground $AURORA_SUCCESS --border-foreground $AURORA_SUCCESS --border double --padding "2 3" --align center \
    "$(icon check) INSTALAÃ‡ÃƒO CONCLUÃDA COM SUCESSO!" \
    "" \
    "$(icon user) UsuÃ¡rio: $ADM_USER" \
    "$(icon info) Dica: Remova a mÃ­dia Live e reinicie o sistema."
separator

# Progresso final
show_progress
gum style --foreground $AURORA_SUCCESS --bold "$(icon check) Todas as etapas concluÃ­das com Ãªxito!"
echo ""

if gum confirm "Deseja reiniciar agora?" --affirmative "ğŸš€ REINICIAR" --negative "âŒ SAIR"; then
    gum style --foreground $AURORA_INFO "$(icon info) SimulaÃ§Ã£o concluÃ­da. ReinÃ­cio simulado."
    sleep 3
    clear
    logo
    separator
    gum style --foreground $AURORA_INFO --border-foreground $AURORA_INFO --border double --padding "2 3" --align center \
        "$(icon info) MODO DEMONSTRAÃ‡ÃƒO" \
        "" \
        "Este Ã© um instalador simulado para fins estÃ©ticos." \
        "Nenhuma modificaÃ§Ã£o real foi realizada no sistema." \
        "" \
        "$(icon logo) Obrigado por testar o Aurora Installer!"
    separator
fi
